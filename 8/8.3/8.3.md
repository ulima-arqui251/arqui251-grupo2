# 8.3. Patrones de Asignación

[Volver al índice](../8.md)

---

## ADR 1: Aplicación del Patrón Frontend-Backend Separation

### Contexto

StudyMate necesita una estrategia de despliegue que permita escalabilidad independiente de frontend y backend, facilite el desarrollo paralelo de equipos, y optimice la entrega de contenido estático vs dinámico. Los escenarios de disponibilidad y rendimiento requieren arquitectura distribuida.

### Alternativas Consideradas

1. **Patrón Frontend-Backend Separation**
   - Frontend desplegado en Vercel (edge locations globales)
   - Backend desplegado en Render (auto-scaling)
   - CDN automático para assets estáticos
   - Separación completa de responsabilidades

2. **Despliegue Monolítico Unificado**
   - Frontend y backend en el mismo servidor
   - Menor complejidad de despliegue
   - Sin optimizaciones de CDN automáticas
   - Escalabilidad limitada

3. **Containerización con Kubernetes**
   - Complejidad operacional alta para equipo pequeño
   - Overhead innecesario para fase inicial

### Criterios de Elección

- Cumplimiento de ESC-06: 1000 estudiantes acceden simultáneamente
- Optimización de ESC-09: Navegación ≤ 2 seg
- Disponibilidad para ESC-20: Panel docente ≥ 99%
- Facilidad de despliegue para equipo pequeño

### Decisión

Se adopta **Frontend-Backend Separation Pattern** con despliegue en plataformas especializadas.

### Sustento

Esta decisión permite:
- **Cumplir ESC-06**: CDN global de Vercel distribuye carga
- **Optimizar ESC-09**: SSG/SSR de Next.js mejora tiempo de carga
- **Asegurar ESC-20**: Auto-scaling de Render mantiene disponibilidad
- **Facilitar desarrollo**: Equipos frontend/backend independientes

---

## ADR 2: Aplicación del Patrón Multi-Instance Deployment

### Contexto

Los diferentes tipos de usuarios (estudiantes, docentes, administradores) tienen patrones de uso y cargas muy diferentes. Se necesita una estrategia que permita optimizar recursos según demanda y preparar escalabilidad granular.

### Alternativas Consideradas

1. **Multi-Instance Deployment**
   - Instancias separadas del backend por tipo de carga
   - Load balancer inteligente según endpoint
   - Escalabilidad granular por función
   - Preparación para BFF futuro

2. **Single Instance Deployment**
   - Una sola instancia del backend
   - Escalamiento vertical únicamente
   - Menos complejidad operacional

3. **Full Microservices Deployment**
   - Cada servicio desplegado independientemente
   - Complejidad operacional muy alta

### Criterios de Elección

- Cumplimiento de ESC-25: 500 simulaciones simultáneas
- Optimización de ESC-19: Asignación masiva de tareas ≤ 1 seg
- Preparación para ESC-29: Escalamiento automático
- Eficiencia de recursos por tipo de carga

### Decisión

Se implementa **Multi-Instance Deployment** con balanceador de carga inteligente.

### Sustento

- **Cumple ESC-25**: Instancia dedicada para simulaciones premium
- **Optimiza ESC-19**: Workers específicos para tareas masivas
- **Facilita ESC-29**: Auto-scaling independiente por función
- **Eficiencia**: Recursos asignados según demanda real

---

## ADR 3: Aplicación del Patrón Database per Environment

### Contexto

StudyMate necesita separar claramente los datos de desarrollo, testing y producción, mientras mantiene consistencia de esquema y facilita testing de escenarios de carga.

### Alternativas Consideradas

1. **Database per Environment Pattern**
   - BD separada por ambiente (dev, test, prod)
   - Scripts de migración consistentes
   - Seeding automático para testing
   - Backup y recuperación por ambiente

2. **Shared Database con Schemas**
   - Una BD con esquemas separados
   - Menor overhead operacional
   - Riesgo de contaminación entre ambientes

3. **In-Memory Database para Testing**
   - Testing rápido pero no representa producción
   - Inconsistencias potenciales

### Criterios de Elección

- Validación de ESC-13: Testing de 10,000 usuarios concurrentes
- Seguridad de datos de producción
- Facilidad de testing automatizado
- Recuperación ante desastres

### Decisión

Se adopta **Database per Environment Pattern** con automatización completa.

### Sustento

- **Valida ESC-13**: Testing de carga en ambiente realista
- **Protege producción**: Aislamiento completo de datos
- **Facilita testing**: Seeding automático para escenarios
- **Asegura recuperación**: Backups independientes por ambiente

---

## Descripción de Aplicación en StudyMate

### Arquitectura de Despliegue

```
┌─────────────────────┐    ┌─────────────────────┐
│   Vercel (Global)   │    │   Render (US-East)  │
│                     │    │                     │
│ ┌─────────────────┐ │    │ ┌─────────────────┐ │
│ │ Student App     │ │    │ │ API Gateway     │ │
│ │ (Next.js SSG)   │ │    │ │ (Auto-scaling)  │ │
│ └─────────────────┘ │    │ └─────────────────┘ │
│                     │    │                     │
│ ┌─────────────────┐ │    │ ┌─────────────────┐ │
│ │ Teacher Panel   │ │───▶│ │ Auth Service    │ │
│ │ (Next.js SSR)   │ │    │ │ (2 instances)   │ │
│ └─────────────────┘ │    │ └─────────────────┘ │
│                     │    │                     │
│ ┌─────────────────┐ │    │ ┌─────────────────┐ │
│ │ Admin Panel     │ │    │ │ Lesson Service  │ │
│ │ (Next.js SPA)   │ │    │ │ (3 instances)   │ │
│ └─────────────────┘ │    │ └─────────────────┘ │
└─────────────────────┘    └─────────────────────┘
```

### Database Environment Strategy

```yaml
# Development Environment
development:
  database: studymate_dev
  host: localhost
  port: 3306
  pool_size: 5

# Testing Environment  
testing:
  database: studymate_test
  host: localhost
  port: 3306
  pool_size: 10
  seed_data: true

# Production Environment
production:
  database: studymate_prod
  host: ${DB_HOST}
  port: 3306
  pool_size: 20
  ssl: true
  backup_schedule: "0 2 * * *"
```

### Multi-Instance Load Balancing

```nginx
# Nginx configuration para distribución inteligente
upstream student_backend {
    server backend-student-1:3000 weight=3;
    server backend-student-2:3000 weight=3;
    server backend-student-3:3000 weight=2;
}

upstream teacher_backend {
    server backend-teacher-1:3000 weight=2;
    server backend-teacher-2:3000 weight=1;
}

upstream admin_backend {
    server backend-admin-1:3000 weight=1;
}

# Routing rules
location /api/lessons {
    proxy_pass http://student_backend;
}

location /api/teacher {
    proxy_pass http://teacher_backend;
}

location /api/admin {
    proxy_pass http://admin_backend;
}
```

### Deployment Automation

```yaml
# GitHub Actions para CI/CD
name: Deploy StudyMate
on:
  push:
    branches: [main]

jobs:
  deploy-frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v20
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.ORG_ID }}
          vercel-project-id: ${{ secrets.PROJECT_ID }}

  deploy-backend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Deploy to Render
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        run: |
          curl -X POST \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{"serviceId": "${{ secrets.RENDER_SERVICE_ID }}"}' \
            https://api.render.com/v1/services/deploy
```

### Beneficios Obtenidos

1. **Rendimiento Optimizado**:
   - ESC-06: CDN global reduce latencia para 1000+ usuarios
   - ESC-09: SSG/SSR optimiza navegación ≤ 2 seg
   - ESC-21: Edge computing mejora recomendaciones

2. **Disponibilidad Asegurada**:
   - ESC-20: Auto-scaling mantiene panel docente ≥ 99%
   - ESC-29: Instancias independientes por función
   - Redundancia automática en multiple regiones

3. **Escalabilidad Granular**:
   - ESC-25: Instancias dedicadas para simulaciones
   - ESC-19: Workers específicos para tareas masivas
   - Preparación para microservicios futuros

4. **Operaciones Simplificadas**:
   - Despliegue automático con CI/CD
   - Monitoreo integrado por plataforma
   - Backup y recuperación automatizados

### Patrones de Asignación Complementarios

- **Blue-Green Deployment**: Para actualizaciones sin downtime
- **Canary Releases**: Para validación gradual de cambios
- **Circuit Breaker**: Para protección ante fallos de servicios
- **Health Check Pattern**: Para monitoreo continuo de instancias